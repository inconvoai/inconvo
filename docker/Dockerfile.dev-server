FROM node:22-slim AS base

# Install pnpm
ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
RUN corepack enable && corepack prepare pnpm@10.26.0 --activate

# ============================================
# Builder stage - install deps and build
# ============================================
FROM base AS builder

# Install build dependencies (OpenSSL for Prisma, python/make for native modules)
RUN apt-get update && apt-get install -y \
    openssl \
    ca-certificates \
    python3 \
    make \
    g++ \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy package files first for better caching
COPY package.json pnpm-workspace.yaml pnpm-lock.yaml ./
COPY turbo.json ./

# Copy all package.json files for workspace resolution
COPY apps/dev-server/package.json ./apps/dev-server/
COPY packages/agents/package.json ./packages/agents/
COPY packages/connect/package.json ./packages/connect/
COPY packages/types/package.json ./packages/types/
COPY packages/ui/package.json ./packages/ui/
COPY packages/eslint-config/package.json ./packages/eslint-config/
COPY packages/typescript-config/package.json ./packages/typescript-config/

# Install dependencies (ignore scripts - prisma generate needs schema which comes later)
RUN pnpm config set node-linker hoisted && pnpm install --frozen-lockfile --ignore-scripts

# Copy source code
COPY apps/dev-server ./apps/dev-server
COPY packages ./packages

# Generate Prisma client and build
ENV SKIP_ENV_VALIDATION=true
RUN pnpm --filter dev-server exec prisma generate && pnpm --filter dev-server build

# ============================================
# Runner stage - minimal production image
# ============================================
FROM base AS runner

# Install runtime dependencies only
RUN apt-get update && apt-get install -y openssl ca-certificates && rm -rf /var/lib/apt/lists/*

# Version from pnpm-workspace.yaml catalog (passed via build arg)
ARG PRISMA_VERSION=7.3.0

WORKDIR /app

# Copy standalone build from builder
COPY --from=builder /app/apps/dev-server/.next/standalone ./
COPY --from=builder /app/apps/dev-server/.next/static ./apps/dev-server/.next/static
COPY --from=builder /app/apps/dev-server/public ./apps/dev-server/public

# Copy Prisma schema for migrations
COPY --from=builder /app/apps/dev-server/prisma ./apps/dev-server/prisma

# Install Prisma CLI globally for db push
RUN npm install -g prisma@${PRISMA_VERSION}

# Copy entrypoint script
COPY docker/entrypoint/dev-server.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

EXPOSE 26686

ENV PORT=26686
ENV HOSTNAME=0.0.0.0
ENV NODE_ENV=production

ENTRYPOINT ["/entrypoint.sh"]
CMD ["node", "server.js"]
