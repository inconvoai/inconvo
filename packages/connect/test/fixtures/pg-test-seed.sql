/* ============================================================
   PostgreSQL Test Seed for packages/connect (public + hr)
   - Drops and recreates required schemas/tables
   - Inserts minimal deterministic data for test coverage
   ============================================================ */

BEGIN;

-- Clean public schema tables (order matters for FK dependencies)
DROP TABLE IF EXISTS public.reviews CASCADE;
DROP TABLE IF EXISTS public.orders CASCADE;
DROP TABLE IF EXISTS public.products CASCADE;
DROP TABLE IF EXISTS public.users CASCADE;
DROP TABLE IF EXISTS public.organisations CASCADE;

-- Clean HR schema
DROP SCHEMA IF EXISTS hr CASCADE;
CREATE SCHEMA hr;

-- ============================================================
-- Public schema
-- ============================================================

CREATE TABLE public.organisations (
    id          integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name        varchar(255) NOT NULL UNIQUE,
    created_at  timestamptz  NOT NULL DEFAULT now()
);

CREATE TABLE public.users (
    organisation_id integer NOT NULL,
    id              integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    address         varchar(255),
    email           varchar(255),
    password        varchar(255),
    name            varchar(255),
    city            varchar(255),
    longitude       double precision,
    birth_date      date,
    zip             char(5),
    latitude        double precision,
    created_at      timestamp without time zone,
    last_order_at   timestamp without time zone,
    FOREIGN KEY (organisation_id) REFERENCES public.organisations(id)
);

CREATE TABLE public.products (
    organisation_id integer NOT NULL,
    id              integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ean             char(13),
    title           varchar(255),
    category        varchar(255),
    price           double precision,
    stock_level     integer,
    created_at      timestamp without time zone,
    FOREIGN KEY (organisation_id) REFERENCES public.organisations(id)
);

CREATE TABLE public.orders (
    organisation_id integer NOT NULL,
    id              integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id         integer,
    product_id      integer,
    subtotal        double precision,
    tax             double precision,
    discount        double precision,
    created_at      timestamp without time zone,
    quantity        integer,
    FOREIGN KEY (organisation_id) REFERENCES public.organisations(id),
    FOREIGN KEY (user_id) REFERENCES public.users(id),
    FOREIGN KEY (product_id) REFERENCES public.products(id)
);

CREATE TABLE public.reviews (
    organisation_id integer NOT NULL,
    id              integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    product_id      integer,
    user_id         integer,
    rating          smallint,
    comment         text,
    created_at      timestamp without time zone,
    FOREIGN KEY (organisation_id) REFERENCES public.organisations(id),
    FOREIGN KEY (user_id) REFERENCES public.users(id),
    FOREIGN KEY (product_id) REFERENCES public.products(id)
);

-- ============================================================
-- Public data
-- ============================================================

INSERT INTO public.organisations (id, name, created_at) VALUES
  (1, 'Apple', now()),
  (2, 'Tesla', now());

INSERT INTO public.users (id, organisation_id, email, name, city, created_at, last_order_at) VALUES
  (1, 1, 'alice@apple.com', 'Alice', 'San Francisco', '2024-01-05 10:00:00', '2025-11-01 09:00:00'),
  (2, 1, 'bob@apple.com', 'Bob', 'New York', '2024-02-10 11:00:00', '2024-05-15 12:00:00'),
  (3, 2, 'carla@tesla.com', 'Carla', 'Austin', '2024-03-12 09:30:00', '2024-07-07 15:00:00'),
  (4, 2, 'dinesh@tesla.com', 'Dinesh', 'Seattle', '2024-04-01 08:15:00', '2024-10-10 16:30:00');

INSERT INTO public.products (id, organisation_id, ean, title, category, price, stock_level, created_at) VALUES
  (1, 1, '1234567890124', 'MacBook Pro', 'Laptop', 2499.99, 500, '2024-01-01 00:00:00'),
  (2, 1, '1234567890123', 'iPhone 15', 'Smartphone', 999.99, 150, '2024-01-01 00:00:00'),
  (3, 2, '2345678901234', 'Model S', 'Electric Vehicle', 79999.99, 50, '2024-01-01 00:00:00'),
  (4, 2, '2345678901235', 'Model 3', 'Electric Vehicle', 45999.99, 80, '2024-01-01 00:00:00');

-- Orders spread across months/quarters/days for date-based tests
INSERT INTO public.orders (id, organisation_id, user_id, product_id, subtotal, tax, discount, created_at, quantity) VALUES
  (1, 1, 1, 1, 2500.00, 200.00, 100.00, '2025-11-01 09:00:00', 1), -- MacBook for aggregate filter
  (2, 1, 1, 2, 1000.00, 80.00, 0.00, '2024-01-10 12:00:00', 1),
  (3, 1, 1, 1, 2400.00, 180.00, 200.00, '2024-02-15 14:00:00', 2),
  (4, 1, 2, 2, 1100.00, 90.00, 50.00, '2024-03-20 10:30:00', 1),
  (5, 1, 2, 1, 2600.00, 210.00, 150.00, '2024-05-15 12:00:00', 1),
  (6, 2, 3, 3, 80000.00, 6400.00, 5000.00, '2024-04-05 16:45:00', 1),
  (7, 2, 3, 4, 46000.00, 3680.00, 2000.00, '2024-07-07 15:00:00', 1),
  (8, 2, 4, 3, 82000.00, 6560.00, 3000.00, '2024-10-10 16:30:00', 1);

INSERT INTO public.reviews (id, organisation_id, product_id, user_id, rating, comment, created_at) VALUES
  (1, 1, 1, 1, 5, 'Great laptop', '2024-02-20 10:00:00'),
  (2, 2, 3, 3, 4, 'Excellent car', '2024-04-10 11:00:00');

-- ============================================================
-- HR schema (for multi-schema tests)
-- ============================================================

CREATE TABLE hr.departments (
    id          integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name        varchar(255) NOT NULL,
    budget      double precision,
    location    varchar(255),
    created_at  timestamptz NOT NULL DEFAULT now()
);

CREATE TABLE hr.employees (
    id              integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    department_id   integer NOT NULL REFERENCES hr.departments(id),
    first_name      varchar(255),
    last_name       varchar(255),
    email           varchar(255),
    hire_date       timestamptz,
    salary          double precision,
    job_title       varchar(255),
    manager_id      integer,
    is_active       boolean DEFAULT true
);

CREATE TABLE hr.projects (
    id              integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name            varchar(255),
    department_id   integer REFERENCES hr.departments(id),
    start_date      timestamptz,
    end_date        timestamptz,
    status          varchar(50),
    budget          double precision
);

CREATE TABLE hr.project_assignments (
    id               integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    project_id       integer NOT NULL REFERENCES hr.projects(id),
    employee_id      integer NOT NULL REFERENCES hr.employees(id),
    role             varchar(255),
    hours_allocated  double precision,
    assigned_at      timestamptz NOT NULL DEFAULT now()
);

CREATE TABLE hr.time_entries (
    id           integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    employee_id  integer NOT NULL REFERENCES hr.employees(id),
    project_id   integer NOT NULL REFERENCES hr.projects(id),
    date         timestamptz NOT NULL DEFAULT now(),
    hours        double precision,
    description  varchar(255)
);

INSERT INTO hr.departments (id, name, budget, location) VALUES
  (1, 'Engineering', 1000000, 'SF'),
  (2, 'Sales', 500000, 'NY'),
  (3, 'HR', 200000, 'Remote');

INSERT INTO hr.employees (id, department_id, first_name, last_name, email, hire_date, salary, job_title, manager_id, is_active) VALUES
  (1, 1, 'Alice', 'Nguyen', 'alice@example.com', now() - interval '3 years', 180000, 'Staff Engineer', NULL, true),
  (2, 1, 'Bob', 'Lee', 'bob@example.com', now() - interval '2 years', 120000, 'Engineer', 1, true),
  (3, 2, 'Carla', 'Diaz', 'carla@example.com', now() - interval '1 years', 95000, 'Account Executive', NULL, true),
  (4, 3, 'Dinesh', 'Patel', 'dinesh@example.com', now() - interval '4 years', 105000, 'HR Manager', NULL, true);

INSERT INTO hr.projects (id, name, department_id, start_date, end_date, status, budget) VALUES
  (1, 'Apollo', 1, now() - interval '6 months', NULL, 'active', 250000),
  (2, 'Hermes', 1, now() - interval '18 months', now() - interval '2 months', 'completed', 150000),
  (3, 'Growth-Q1', 2, now() - interval '2 months', NULL, 'active', 100000);

INSERT INTO hr.project_assignments (id, project_id, employee_id, role, hours_allocated) VALUES
  (1, 1, 1, 'Lead', 400),
  (2, 1, 2, 'Contributor', 300),
  (3, 3, 3, 'Owner', 200);

INSERT INTO hr.time_entries (id, employee_id, project_id, hours, description) VALUES
  (1, 1, 1, 8, 'Design review'),
  (2, 2, 1, 6, 'Implementation'),
  (3, 3, 3, 5, 'Customer calls');

COMMIT;
